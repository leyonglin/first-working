<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600354 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="542"/>

<div>
<span><div>    </div><div><div>    </div><div><div>                                                                                     <img src="【模拟真实环境】Zabbix高可用架构_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><hr/><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">一、初始化配置(四台机器一样)</span></font></div><div style="text-align: left;">    1、安装常用包</div><div style="text-align: left;">        root&gt;yum -y install screen sysstat wget vim lsof rdate nc tree psmisc net-tools gcc gcc-c++ zip unzip pcre pcre-devel zlib zlib-devel openssl openssl-devel telnet GeoIP-devel  lua-devel  libevent libevent-devel libmount-devel libmount-devel libtool perl-devel libaio</div><div style="text-align: left;">    2、系统优化</div><div style="text-align: left;">        root&gt;vim /etc/sysctl.conf</div><div style="text-align: left;">            fs.file-max = 65535</div><div style="text-align: left;">            net.ipv4.ip_forward = 1</div><div style="text-align: left;">            net.ipv4.tcp_fin_timeout = 600</div><div style="text-align: left;">            net.ipv4.tcp_max_syn_backlog = 10240</div><div style="text-align: left;">            net.ipv4.tcp_keepalive_time = 1200</div><div style="text-align: left;">            net.ipv4.tcp_synack_retries = 3</div><div style="text-align: left;">            net.ipv4.tcp_syn_retries = 3</div><div style="text-align: left;">            net.ipv4.tcp_max_orphans = 8192</div><div style="text-align: left;">            net.ipv4.tcp_max_tw_buckets = 2000</div><div style="text-align: left;">            net.ipv4.tcp_window_scaling = 0</div><div style="text-align: left;">            net.ipv4.tcp_sack = 0</div><div style="text-align: left;">            net.ipv4.tcp_timestamps = 0</div><div style="text-align: left;">            net.ipv4.tcp_syncookies = 1</div><div style="text-align: left;">            net.ipv4.tcp_tw_reuse = 1</div><div style="text-align: left;">            net.ipv4.tcp_tw_recycle = 1</div><div style="text-align: left;">            net.ipv4.ip_local_port_range = 1024 65000</div><div style="text-align: left;">            net.core.somaxconn= 1024</div><div style="text-align: left;">            vm.overcommit_memory=1</div><div style="text-align: left;">            net.ipv4.icmp_echo_ignore_broadcasts = 1</div><div style="text-align: left;">            net.ipv4.icmp_echo_ignore_all = 1</div><div style="text-align: left;">            net.ipv4.ip_default_ttl = 128</div><div style="text-align: left;">            net.ipv4.conf.all.accept_redirects = 0</div><div style="text-align: left;"><span>    </span><span>    </span><span>    </span>net.ipv6.conf.all.disable_ipv6 = 1<br/></div><div style="text-align: left;">        root&gt;sysctl -p</div><div style="text-align: left;">    3、Linux增加文件句柄打开文件数量</div><div style="text-align: left;">        root&gt;vim /etc/security/limits.conf</div><div style="text-align: left;">            * soft nproc 65535</div><div style="text-align: left;">            * hard nproc 65535</div><div style="text-align: left;">            * soft nofile 65535</div><div style="text-align: left;">            * hard nofile 65535</div><div style="text-align: left;">    4、检查网卡配置</div><div style="text-align: left;">        root&gt;vim /etc/sysconfig/network-scripts/ifcfg-ens33 (多个网卡要全部检查一遍)</div><div style="text-align: left;">            ONBOOT=yes</div><div style="text-align: left;">    5、创建用户</div><div style="text-align: left;">        root&gt;useradd blog  &amp;&amp; passwd blog        # 只读用户</div><div style="text-align: left;">        root&gt;useradd mtadmin  &amp;&amp; passwd mtadmin        # 程序用户</div><div style="text-align: left;">        root&gt;passwd root        # 修改root密码</div><div style="text-align: left;">    6、su优化</div><div style="text-align: left;">        root&gt;vim /etc/bashrc</div><div style="text-align: left;">            alias su=&quot;su -&quot;        # 使用su命令切换身份，也必须切换Shell环境</div><div style="text-align: left;">        root&gt;source /etc/bashrc</div><div style="text-align: left;">    7、firewalld通用设置</div><div style="text-align: left;">        root&gt;systemctl restart firewalld  &amp;&amp;  systemctl enable firewalld        # 开启firewalld并加入开机自启</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --new-ipset=ssh_whitelist --type=hash:ip        # 创建ssh ipset表</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=113.61.35.0/24        # 添加公司IP到ssh白名单(虚拟机环境ip另算)</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.3        # 虚拟机ssh白名单</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;ssh_whitelist&quot; port port=&quot;22&quot; protocol=&quot;tcp&quot; accept'        #开启ssh远程登录白名单</div><div style="text-align: left;">        root&gt;firewall-cmd --remove-service=ssh --permanent        # 移除ssh服务</div><div style="text-align: left;">        root&gt;firewall-cmd --reload        # 重启firewalld</div><div style="text-align: left;">    8、禁root登录</div><div style="text-align: left;">        root&gt;vim /etc/ssh/sshd_config</div><div style="text-align: left;">            PermitRootLogin no</div><div style="text-align: left;">            UseDNS no</div><div style="text-align: left;">            MaxAuthTries 3</div><div style="text-align: left;">            Protocol 2</div><div style="text-align: left;">        root&gt;systemctl restart sshd</div><div style="text-align: left;">    9、关闭selinux及配置时间同步</div><div style="text-align: left;">        a、关闭selinux</div><div style="text-align: left;">        root&gt;setenforce 0</div><div style="text-align: left;">        root&gt;vim /etc/selinux/config</div><div style="text-align: left;">            SELINUX=disabled</div><div style="text-align: left;">        b、时间同步</div><div style="text-align: left;">        root&gt;timedatectl set-timezone Asia/Shanghai</div><div style="text-align: left;">        root&gt;crontab -e  </div><div style="text-align: left;">            #rdate /minute</div><div style="text-align: left;">            */5 * * * *    /bin/rdate -s time.nist.gov &gt;&gt;/var/log/rdate.log 2&gt;&amp;1</div><div style="text-align: left;">    10、隐藏服务器信息</div><div style="text-align: left;">        root&gt;mv /etc/issue /etc/system.bak</div><div style="text-align: left;">        root&gt;mv /etc/issue.net /etc/system.netbak</div><div style="text-align: left;"><br/></div><hr/><div style="text-align: left;"></div><div style="text-align: left;"></div><div style="text-align: left;"><span style="font-size: 12pt; font-weight: bold;">二、数据库服务器搭建</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">        192.168.110.212        mysql+keepalived</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">        192.168.110.213        mysql+keepalived</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">        vip：192.168.110.221</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;"><br/></span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">    1、安装xtrabackup</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">        root&gt;yum -y install  </span><a href="http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm" style="font-size: 13.3333px;">http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm</a><span style="font-size: 13.3333px;">    # 添加xtrabackup源</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;">        root&gt;yum -y install percona-xtrabackup-24 qpress</span></div><div style="text-align: left;"><span style="font-size: 13.3333px;"><br/></span></div><div style="text-align: left;">    2、firewalld配置</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --new-ipset=db_whitelist --type=hash:ip</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --new-ipset=zabbix_whitelist --type=hash:ip</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=113.61.35.0/24        # 添加公司IP到db白名单(虚拟机环境ip另算)</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.3        # 虚拟机db白名单</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.210</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.211</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.213        # 在192.168.110.212上执行</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.212        # 在192.168.110.213上执行</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=db_whitelist --add-entry=192.168.110.220</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.210</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.211</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.220</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.213        # 在192.168.110.212上执行</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.212        # 在192.168.110.213上执行</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.221</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.210</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.211</div><div style="text-align: left;">        root&gt;firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT    # 开启vrrp 协议通信</div></div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;db_whitelist&quot; port port=&quot;3306&quot; protocol=&quot;tcp&quot; accept'</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10050&quot; protocol=&quot;tcp&quot; accept'</div><div style="text-align: left;">        root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10050&quot; protocol=&quot;udp&quot; accept'</div><div style="text-align: left;">        root&gt;firewall-cmd --reload</div><div style="text-align: left;"><br/></div><div style="text-align: left;">    3、环境变量优化</div><div style="text-align: left;">        root&gt;vim /etc/profile   ##最后一行添加</div><div style="text-align: left;">            ################################</div><div style="text-align: left;">            HISTSIZE=100</div><div style="text-align: left;">            export TMOUT=600</div><div style="text-align: left;">            export HISTTIMEFORMAT=&quot;%F %T &quot;</div><div style="text-align: left;">            #######mysql&amp;&amp;redis环境变量##########</div><div style="text-align: left;">            export PATH=$PATH:/opt/apps/mysql/bin/</div><div style="text-align: left;">        root&gt;source /etc/profile</div><div style="text-align: left;"><br/></div><div>    4、创建目录</div><div>        root&gt;cd /opt/  &amp;&amp; mkdir apps scripts conf  src data backup logs</div><div>        root&gt;mkdir -p /opt/data/data_3306</div><div><br/></div><div>    5、部署mysql</div><div>        a、从下载站下载mysql5.7.17源码包</div><div>            root&gt;wget --http-user=downloader  --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf --no-check-certificate <a href="https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/mysql-5.7.17-linux-glibc2.5-x86_64.tar.xz">https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/mysql-5.7.17-linux-glibc2.5-x86_64.tar.xz</a></div><div>        b、从下载站下载mysql配置文件</div><div>            root&gt;wget --http-user=downloader  --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf --no-check certificate <a href="https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/mysql-5.7.17-linux-glibc2.5-x86_64.tar.xz">https://hkdownload.zhushuqt.com:8443/download/</a>%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/db/my_16303.cnf</div><div>        c、安装mysql</div><div>            root&gt;cp /opt/src/my_16303.cnf /opt/conf/</div><div>            root&gt;mv my_16303.cnf my_3306.cnf</div><div>            root&gt;sed -i &quot;s/16303/3306/g&quot; my_3306.cnf</div><div>            root&gt;vim /opt/conf/my_3306.cnf</div><div>                server-id = 3306213        # 保证两台的id唯一</div><div>                其他配置按实际情况</div><div>            root&gt;tar -xf /opt/src/mysql-5.7.17-linux-glibc2.5-x86_64.tar.xz -C /opt/apps/        # 解压</div><div>            root&gt;mv /opt/apps/mysql-5.7.17-linux-glibc2.5-x86_64/ /opt/apps/mysql</div><div>            root&gt;chown -R mtadmin.mtadmin /opt/</div><div>            root&gt;/opt/apps/mysql/bin/mysqld --defaults-file=/opt/conf/my_3306.cnf --initialize-insecure --user=mtadmin        # 初始化</div><div>            mtadmin&gt;/opt/apps/mysql/bin/mysqld --defaults-file=/opt/conf/my_3306.cnf --user=mtadmin &amp;        # 启动</div><div>        d、数据库初始设置</div><div>            root&gt;mysql -u root -p -S /opt/data/data_3306/mysql.sock</div><div>                mysql&gt;set password=PASSWORD(&quot;qweQWE123!@#&quot;);        # 设置root密码</div><div>                mysql&gt;flush privileges;</div><div>        e、互为主主</div><div>            root&gt;mysql -u root -p -S /opt/data/data_3306/mysql.sock</div><div>                mysql&gt;GRANT REPLICATION SLAVE ON *.* TO myrync@'192.168.110.213' IDENTIFIED BY 'MyryncCloud';        # 192.168.110.212上执行</div><div>                mysql&gt;GRANT REPLICATION SLAVE ON *.* TO myrync@'192.168.110.212' IDENTIFIED BY 'MyryncCloud';        # 192.168.110.213上执行</div><div>                mysql&gt;CHANGE MASTER TO MASTER_HOST='192.168.110.213',MASTER_USER='myrync',MASTER_PASSWORD='MyryncCloud',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=154;     # 192.168.110.212上执行</div><div>                mysql&gt;CHANGE MASTER TO MASTER_HOST='192.168.110.212',MASTER_USER='myrync',MASTER_PASSWORD='MyryncCloud',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=154;     # 192.168.110.213上执行</div><div>                mysql&gt;start slave;        # 两台机器上执行</div><div><br/></div><div>    6、安装keepalived（两台稍有不一样）</div><div>        a、yum安装</div><div>            root&gt;yum -y install keepalived</div><div>        b、编写mysql健康检查脚本</div><div>            root&gt;vim /opt/scripts/check_mysql.sh        # 两台机器一样</div><div>                #!/bin/bash</div><div>                # 时间变量</div><div>                d=`date --date today +'%Y-%m-%d %H:%M:%S'`</div><div>                # 查看mysql进程</div><div>                n=`ps -C mysqld --no-heading | wc -l`</div><div>                # 如果进程为0，尝试启动mysql，且再次检测mysql进程</div><div>                # 如果还为0，说明mysql无法启动，退出脚本返回状态码1</div><div>                if [ $n -eq &quot;0&quot; ];then</div><div>                  su mtadmin -c &quot;/opt/apps/mysql/bin/mysqld --defaults-file=/opt/conf/my_3306.cnf --user=mtadmin &amp;&quot; &gt;&gt;/dev/null 2&gt;&amp;1</div><div>                  sleep 3</div><div>                  n2=`ps -C mysqld --no-heading | wc -l`</div><div>                  if [ $n2 -eq &quot;0&quot; ];then</div><div>                    echo &quot;$d mysql down,stop keepalived&quot; &gt;&gt; /opt/logs/check_mysql.log</div><div>                    exit 1</div><div>                  fi</div><div>                fi</div><div><br/></div><div>        c、配置keepalived主配置文件</div><div>            root&gt;vim /etc/keepalived/keepalived.conf</div><div>                <span style="font-weight: bold;">192.168.110.212上：</span></div><div>                    global_defs {</div><div>                        notification_email {</div><div>                        root@localhost    # 收邮件人，可定义多个</div><div>                        }</div><div>                        notification_email_from kaadmin@localhost    # 发邮件人可以伪装</div><div>                        smtp_server 127.0.0.1</div><div>                        smtp_connect_timeout 30</div><div>                        router_id LVS_DEVEL</div><div>                        script_user root</div><div>                    }</div><div><br/></div><div>                    vrrp_script chk_mysql {</div><div>                        script &quot;/bin/bash /opt/scripts/check_mysql.sh&quot;</div><div>                        interval 3    # 脚本执行间隔</div><div><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span>weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）<br/></div><div>                        fall    2    # 尝试2次都成功才成功</div><div>                        rise 2    # 尝试2次都失败才失败</div><div>                    }</div><div><br/></div><div>                    vrrp_instance VI_2 {    # 每一个vrrp_instance就是定义一个虚拟路由器</div><div>                        state MASTER    # 由初始状态转换为master状态</div><div>                        interface ens33    # 根据实际情况填写网卡名</div><div>                        virtual_router_id 55    # 虚拟路由的id号，一般不大于255</div><div>                        priority 100    # 初始化优先级</div><div>                        advert_int 1    # 初始化通告</div><div>                        authentication {</div><div>                            auth_type PASS        # 认证机制</div><div>                            auth_pass db123321    # 密码</div><div>                        }</div><div>                        virtual_ipaddress {</div><div>                            192.168.110.221</div><div>                        }</div><div>                        track_script {</div><div>                            chk_mysql</div><div>                        }</div><div>                    }</div><div><br/></div><div>                <span style="font-weight: bold;">192.168.110.213上：</span></div><div>                    global_defs {</div><div>                        notification_email {</div><div>                        root@localhost    # 收邮件人，可定义多个</div><div>                        }</div><div>                        notification_email_from kaadmin@localhost    # 发邮件人可以伪装</div><div>                        smtp_server 127.0.0.1</div><div>                        smtp_connect_timeout 30</div><div>                        router_id LVS_DEVEL</div><div>                        script_user root</div><div>                    }</div><div><br/></div><div>                    vrrp_script chk_mysql {</div><div>                        script &quot;/bin/bash /opt/scripts/check_mysql.sh&quot;</div><div>                        interval 3    # 脚本执行间隔</div><div><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span>weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）<br/></div><div>                        fall    2    # 尝试2次都成功才成功</div><div>                        rise 2    # 尝试2次都失败才失败</div><div>                    }</div><div><br/></div><div>                    vrrp_instance VI_2 {    # 每一个vrrp_instance就是定义一个虚拟路由器</div><div>                        state BACKUP    # 由初始状态转换为backup状态</div><div>                        interface ens33    # 根据实际情况填写网卡名</div><div>                        virtual_router_id 55    # 虚拟路由的id号，一般不大于255</div><div>                        priority 90    # 初始化优先级</div><div>                        advert_int 1    # 初始化通告</div><div>                        authentication {</div><div>                            auth_type PASS        # 认证机制</div><div>                            auth_pass db123321    # 密码</div><div>                        }</div><div>                        virtual_ipaddress {</div><div>                            192.168.110.221</div><div>                        }</div><div>                        track_script {</div><div>                            chk_mysql</div><div>                        }</div><div>                    }</div><div><br/></div><div>        d、配置开机自启并启动</div><div>            root&gt;systemctl enable keepalived</div><div>            root&gt;systemctl start keepalived</div><div><br/></div><div>    7、配置zabbix_agentd开机自启</div><div>            root&gt;chmod +x /etc/rc.d/rc.local</div><div>            root&gt;echo -e &quot;###开机自启zabbix_agentd###\nsu mtadmin -c \&quot;/home/mtadmin/apps/zabbix/sbin/zabbix_agentd\&quot;&quot; &gt;&gt; /etc/rc.local</div><div><br/></div><div>    8、配置mtadmin用户sudo权限</div><div>        root&gt;visudo        # 在最后行添加保存即可</div><div>            Cmnd_Alias SCRIPT_COMMAND = /usr/bin/vim /etc/keepalived/keepalived.conf, /usr/bin/systemctl restart keepalived, /usr/bin/systemctl start keepalived, /usr/bin/systemctl stop keepalived, /usr/bin/tailf /var/log/messages, /usr/bin/tail /var/log/messages, /usr/bin/vim /var/log/messages</div><div>            mtadmin ALL = NOPASSWD:SCRIPT_COMMAND</div><div>        mtadmin&gt;vim /home/mtadmin/.bashrc    # 添加别名</div><div>            alias keepalived_stop=&quot;sudo /usr/bin/systemctl stop keepalived&quot;</div><div>            alias keepalived_start=&quot;sudo /usr/bin/systemctl start keepalived&quot;</div><div>            alias keepalived_restart=&quot;sudo /usr/bin/systemctl restart keepalived&quot;</div><div>        mtadmin&gt;source /home/mtadmin/.bashrc</div><div><br/></div><hr/><div><span style="font-size: 12pt; font-weight: bold;">三、zabbix-server服务器搭建</span></div><div><span style="font-size: 10pt;">    192.168.110.210    zabbix+nginx+php+keepalived+rsync+sersync</span></div><div><span style="font-size: 10pt;">    192.168.110.211    zabbix+nginx+php+keepalived+rsync+sersync</span></div><div><span style="font-size: 10pt;">    vip: 192.168.110.220</span></div><div>1、firewalld设置</div><div>    root&gt;firewall-cmd --permanent --new-ipset=zabbix_whitelist --type=hash:ip</div><div>    root&gt;firewall-cmd --permanent --new-ipset=rsync_whitelist --type=hash:ip</div><div>    root&gt;firewall-cmd --permanent --new-ipset=web_whitelist --type=hash:ip</div><div>    root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.211        # 在192.168.110.210上执行</div><div style="text-align: left;">    root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.210        # 在192.168.110.211上执行</div><div>    root&gt;firewall-cmd --permanent --ipset=ssh_whitelist --add-entry=192.168.110.220</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.212</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.213</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.221</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.220</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.211        # 在192.168.110.210上执行</div><div>    root&gt;firewall-cmd --permanent --ipset=zabbix_whitelist --add-entry=192.168.110.210        # 在192.168.110.211上执行</div><div>    root&gt;firewall-cmd --permanent --ipset=rsync_whitelist --add-entry=192.168.110.211        # 在192.168.110.210上执行</div><div>    root&gt;firewall-cmd --permanent --ipset=rsync_whitelist --add-entry=192.168.110.210        # 在192.168.110.211上执行</div><div>    root&gt;firewall-cmd --permanent --ipset=rsync_whitelist --add-entry=192.168.110.220</div><div>    root&gt;firewall-cmd --permanent --ipset=web_whitelist --add-entry=113.61.35.0/24        # 添加公司IP到web白名单(虚拟机环境ip另算)</div><div>    root&gt;firewall-cmd --permanent --ipset=web_whitelist --add-entry=192.168.110.3        # 虚拟机web白名单</div><div>    root&gt;firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT    # 开启vrrp 协议通信</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10051&quot; protocol=&quot;tcp&quot; accept'</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10051&quot; protocol=&quot;udp&quot; accept'</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10050&quot; protocol=&quot;tcp&quot; accept'</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;zabbix_whitelist&quot; port port=&quot;10050&quot; protocol=&quot;udp&quot; accept'</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;rsync_whitelist&quot; port port=&quot;1873&quot; protocol=&quot;tcp&quot; accept'</div><div>    root&gt;firewall-cmd --permanent --add-rich-rule='rule family=&quot;ipv4&quot; source ipset=&quot;web_whitelist&quot; port port=&quot;80&quot; protocol=&quot;tcp&quot; accept'</div><div>    root&gt;firewall-cmd --reload</div><div><br/></div><div>2、环境变量优化</div><div>    root&gt;vim /etc/profile   ##最后一行添加</div><div style="text-align: left;">            ################################</div><div style="text-align: left;">            HISTSIZE=100</div><div style="text-align: left;">            export TMOUT=600</div><div>            export HISTTIMEFORMAT=&quot;%F %T &quot;</div><div>            #########rsync环境变量########</div><div>            export PATH=$PATH:/opt/apps/rsync/bin/</div><div>    root&gt;source /etc/profile</div><div><br/></div><div>3、创建目录</div><div>    root&gt;cd /opt/  &amp;&amp; mkdir apps logs scripts src</div><div>    root&gt;cd /opt/logs &amp;&amp; mkdir zabbix nginx</div><div><br/></div><div>4、部署nginx环境</div><div>    a、从下载站下载nginx源码包,nginx 配置文件</div><div>        root&gt;wget --http-user=downloader  --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf --no-check-certificate <a href="https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/nginx-1.10.3.tar.gz">https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/nginx-1.10.3.tar.gz</a></div><div>        root&gt;wget --http-user=downloader  --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf --no-check-certificate <a href="https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/nginx-1.10.3.tar.gz">https://hkdownload.zhushuqt.com:8443/download/</a>%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/nginx/nginx.conf</div><div>        root&gt;wget --http-user=downloader  --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf --no-check-certificate <a href="https://hkdownload.zhushuqt.com:8443/download/%E9%80%9A%E7%94%A8%E5%8C%85/nginx-1.10.3.tar.gz">https://hkdownload.zhushuqt.com:8443/download/</a>%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/nginx/vhosts/http_default_server.conf</div><div><br/></div><div>    b、安装</div><div>        root&gt;cd /opt/src/ &amp;&amp; tar -xf nginx-1.10.3.tar.gz    # 解压</div><div>        root&gt;cd /opt/src/nginx-1.10.3 &amp;&amp; ./configure --prefix=/opt/apps/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-ipv6 --with-http_realip_module  --user=mtadmin --group=mtadmin</div><div>        root&gt;cd /opt/src/nginx-1.10.3 &amp;&amp; make &amp;&amp; make install</div><div><br/></div><div>    c、配置</div><div>        root&gt;cd /opt/apps/nginx/conf/ &amp;&amp; rm -f nginx.conf    # 删除默认配置文件</div><div>        root&gt;mv /opt/src/nginx.conf /opt/apps/nginx/conf/    </div><div>        root&gt;mkdir /opt/apps/nginx/conf/vhosts</div><div>        root&gt; vim /opt/apps/nginx/conf/nginx.conf        # 修改</div><div>                ##############GeoIP 访问IP限制#####</div><div>                geoip_country       /opt/apps/nginx/conf/GeoIP.dat;</div><div>                geoip_city          /opt/apps/nginx/conf/GeoLiteCity.dat;</div><div>                geoip_proxy     0.0.0.0/0;</div><div>                geoip_proxy_recursive on;</div><div>                geo $remote_addr $ip_whitelist {</div><div>                default 0;</div><div>                include ip.conf;</div><div>                }</div><div>                ####IP黑名单##</div><div>                include  blacklist.conf;</div><div>                include  vhosts/tgapp/*.conf;</div><div>                include  vhosts/example/*.conf;</div><div>        ###########以上全部删除#########</div><div>        root&gt;mv /opt/src/http_default_server.conf /opt/apps/nginx/conf/vhosts/</div><div>        root&gt;mv /opt/apps/nginx/conf/vhosts/http_default_server.conf /opt/apps/nginx/conf/vhosts/http_default_server.conf.bak        # 测试环境暂用ip访问</div><div>        root&gt;vim /opt/apps/nginx/conf/vhosts/web.conf</div><div>            server {</div><div>                listen       80;</div><div>                server_name  localhost;</div><div>                location / {</div><div>                    root    html/zabbix;</div><div>                    index   index.php index.html index.htm;</div><div>                }</div><div>                location ~ \.php$ {</div><div>                    root   html/zabbix;</div><div>                    fastcgi_pass   127.0.0.1:9000;</div><div>                    fastcgi_index   index.php;</div><div>                    fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div>                    include    fastcgi_params;</div><div>                }</div><div><br/></div><div>                access_log    /opt/logs/nginx/web_access.log  main;</div><div>                error_log    /opt/logs/nginx/web_error.log   error;</div><div>        }</div><div><br/></div><div>    d、配置sudo权限</div><div>        root&gt;visudo        # 在最后行添加保存即可</div><div>            Cmnd_Alias SCRIPT_COMMAND = /opt/apps/nginx/sbin/nginx</div><div>            mtadmin ALL = NOPASSWD:SCRIPT_COMMAND</div><div><br/></div><div>5、部署php环境（yum安装）</div><div>        a、安装配置</div><div>            root&gt;yum -y install php php-fpm php-gd php-bcmath php-mbstring php-xml php-mysql</div><div>            root&gt;vim /etc/php.ini</div><div>               date.timezone = Asia/Shanghai</div><div>               max_execution_time = 300</div><div>               post_max_size = 32M    </div><div>               max_input_time = 300</div><div>               always_populate_raw_post_data = -1</div><div>            root&gt;vim /etc/php-fpm.conf</div><div>              log_level = error</div><div>               daemonize = yes</div><div>            root&gt;systemctl enable php-fpm        # 加入开机自启</div><div>            root&gt;systemctl start php-fom</div><div>        b、配置sudo、alias别名</div><div>            root&gt;visudo        # 添加sudo权限</div><div>                Cmnd_Alias SCRIPT_COMMAND = /opt/apps/nginx/sbin/nginx, /usr/bin/systemctl stop php-fpm, /usr/bin/systemctl start php-fpm, /usr/bin/systemctl restart php-fpm    # 在后面添加</div><div>            root&gt;vim /home/mtadmin/.bashrc    # 添加php启动别名</div><div>                alias php_start=&quot;sudo /usr/bin/systemctl start php-fpm&quot;</div><div>                alias php_stop=&quot;sudo /usr/bin/systemctl stop php-fpm&quot;</div><div>                alias php_restart=&quot;sudo /usr/bin/systemctl restart php-fpm&quot;</div><div><br/></div><div>6、部署zabbix环境</div><div>    a、从本地上传zabbix-3.4.1.tar.gz包</div><div>    b、安装依赖包</div><div>        root&gt;yum -y install mysql-devel net-snmp-devel curl curl-devel</div><div>    c、安装</div><div>        root&gt;cd /opt/src &amp;&amp; tar -xf zabbix-3.4.1.tar.gz </div><div>        root&gt;cd /opt/src/zabbix-3.4.1 &amp;&amp; ./configure --prefix=/opt/apps/zabbix --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl --with-openssl</div><div>        root&gt;make &amp;&amp; make install</div><div>    d、配置数据库</div><div>        root&gt;scp /opt/src/zabbix-3.4.1/database/mysql/*.sql mtadmin@192.168.110.212:/opt/src/        # scp数据库sql文件到数据192.168.110.212，传到任意数据库上操作都可，因为做了主主</div><div>        ###在数据库服务器上操作</div><div>        root&gt;mysql -u root -p -S /opt/data/data_3306/mysql.sock</div><div>        mysql&gt;create database zabbix character set utf8;</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.210' identified by 'qwe123';</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.211' identified by 'qwe123';</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.212' identified by 'qwe123';</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.213' identified by 'qwe123';</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.220' identified by 'qwe123';</div><div>        mysql&gt;grant all on zabbix.* to zabbix@'192.168.110.221' identified by 'qwe123';</div><div>        mysql&gt;flush privileges;</div><div>        mysql&gt;use zabbix;</div><div>        mysql&gt;source /opt/src/schema.sql;        # 导库一定要按顺序</div><div>        mysql&gt;source /opt/src/images.sql;</div><div>        mysql&gt;source /opt/src/data.sql;</div><div>        mysql&gt;quit</div><div>    e、配置(此处因为是虚拟机，只配置必要地方，其他优化暂不修改)</div><div>        root&gt;vim /opt/apps/zabbix/etc/zabbix_server.conf</div><div>            SourceIP=192.168.110.220        # 定义出口ip（很重要）</div><div>            LogFile=/opt/logs/zabbix/zabbix_server.log</div><div>            DBHost=192.168.110.221            # 数据库连接为vip</div><div>            DBName=zabbix</div><div>            DBUser=zabbix</div><div>            DBPassword=qwe123</div><div>            DBPort=3306</div><div>        root&gt;vim /opt/apps/zabbix/etc/zabbix_agentd.conf</div><div>            LogFile=/opt/logs/zabbix/zabbix_agentd.log</div><div>            Server=127.0.0.1,192.168.110.220</div><div>            ListenPort=10050</div><div>            ServerActive=127.0.0.1,192.168.110.220</div><div>            Hostname=Zabbix-server-192.168.110.210            # 此处两台不一样</div><div>            Include=/opt/apps/zabbix/etc/zabbix_agentd.conf.d/*.conf</div><div>            /opt/apps/zabbix/etc/zabbix_agentd.conf.d/*.conf</div><div>            UnsafeUserParameters=1</div><div>    f、php静态文件配置</div><div>        root&gt;mkdir /opt/apps/nginx/html/zabbix</div><div>        root&gt;cp -rf /opt/src/zabbix-3.4.1/frontends/php/* /opt/apps/nginx/html/zabbix/</div><div>        root&gt;chown -R mtadmin.mtadmin /opt/</div><div>    g、配置zabbix_agentd开机自启</div><div>        root&gt;chmod +x /etc/rc.d/rc.local</div><div>        root&gt;echo -e &quot;###开机自启zabbix_agentd###\nsu mtadmin -c \&quot;/home/mtadmin/apps/zabbix/sbin/zabbix_agentd\&quot;&quot; &gt;&gt; /etc/rc.local</div><div><br/></div><div>7、部署keepalived环境</div><div>    a、yum安装keepalived（两台稍有不一样）</div><div>        root&gt;yum -y install keepalived</div><div>    b、编写zabbix、nginx健康检查脚本</div><div>        root&gt;vim /opt/scripts/check_ng_zbx.sh        # 两台机器一样</div><div>            #!/bin/bash</div><div>            if [ $# -ne &quot;1&quot; ];then</div><div>              exit 1</div><div>            fi</div><div>            # 时间变量</div><div>            d=`date --date today +'%Y-%m-%d %H:%M:%S'`</div><div>            # 查看nginx进程</div><div>            ng=`ps -ef | grep nginx:\ master | grep -v grep | wc -l`</div><div>            # 查看zabbix进程</div><div>            zbx=`ps -ef |grep zabbix_server | grep -v grep | wc -l`</div><div>            # 判断keepalived是否为MASTER状态</div><div>            vip=`hostname -I | grep -o &quot;192.168.110.220&quot; | wc -l`        # 此处ip为vip                </div><div>            # 如果进程为0，尝试启动nginx/zabbix，且再次检测nginx/zabbix进程</div><div>            # 如果还为0，说明nginx/zabbix无法启动，此时退出脚本返回状态码1</div><div>            case $1 in</div><div>              nginx)</div><div>                if [ $ng -eq &quot;0&quot; ];then</div><div>                  su mtadmin -c &quot;sudo /opt/apps/nginx/sbin/nginx&quot; &gt;&gt;/dev/null 2&gt;&amp;1</div><div>                  sleep 1</div><div>                  ng2=`ps -ef | grep nginx:\ master | grep -v grep | wc -l`</div><div>                  if [ $ng2 -eq &quot;0&quot; ];then</div><div>                    echo &quot;$d nginx down,exit 1&quot; &gt;&gt; /opt/logs/check_ng_zbx.log</div><div>                    exit 1</div><div>                  else</div><div>                    echo &quot;$d restart nginx success!&quot; &gt;&gt; /opt/logs/check_ng_zbx.log</div><div>                  fi</div><div>                fi</div><div>                ;;</div><div>              zabbix)</div><div>                if [ $vip -eq &quot;0&quot; ];then</div><div>                  if [ $zbx -ne &quot;0&quot; ];then</div><div>                    killall zabbix_server</div><div>                  fi</div><div>                else</div><div>                  if [ $zbx -eq &quot;0&quot; ];then</div><div>                    su mtadmin -c &quot;/opt/apps/zabbix/sbin/zabbix_server&quot; &gt;&gt;/dev/null 2&gt;&amp;1</div><div>                    sleep 1</div><div>                    zbx2=`ps -ef |grep zabbix_server | grep -v grep | wc -l`</div><div>                    if [ $zbx2 -eq &quot;0&quot; ];then</div><div>                      echo &quot;$d zabbix_server down,exit 1&quot; &gt;&gt; /opt/logs/check_ng_zbx.log</div><div>                      exit 1</div><div>                    else</div><div>                      echo &quot;$d restart zabbix success!&quot; &gt;&gt; /opt/logs/check_ng_zbx.log</div><div>                    fi</div><div>                  fi</div><div>                fi</div><div>                ;;</div><div>            esac</div><div><br/></div><div>    c、编写keepalived状态切换执行脚本</div><div>        root&gt;vim /opt/scripts/switch_keep.sh</div><div>            #!/bin/bash</div><div>            # 当keepalived状态切换时执行</div><div>            # 时间变量</div><div>            d=`date --date today +'%Y-%m-%d %H:%M:%S'`</div><div>            if [ $# -ne &quot;1&quot; ];then</div><div>              echo &quot;USE /bin/bash /opt/scripts/$0 {master|backup}&quot; &amp;&amp;  exit 1</div><div>            fi</div><div><br/></div><div>            # 查看zabbix进程</div><div>            zbx=`ps -ef |grep zabbix_server | grep -v grep | wc -l`</div><div><br/></div><div>            case $1 in</div><div>              master)</div><div>                if [ $zbx -eq &quot;0&quot; ];then</div><div>                  sleep 30</div><div>                  su mtadmin -c &quot;/opt/apps/zabbix/sbin/zabbix_server&quot;</div><div>                  echo &quot;$d switch MASTER,start zabbix_server&quot; &gt;&gt;  /opt/logs/check_ng_zbx.log</div><div>                else</div><div>                  echo &quot;$d switch MASTER&quot; &gt;&gt;  /opt/logs/check_ng_zbx.log</div><div>                fi</div><div>                ;;</div><div>              backup)</div><div>                if [ $zbx -ne &quot;0&quot; ];then</div><div>                  killall zabbix_server</div><div>                  echo &quot;$d switch BACKUP,stop zabbix_server&quot; &gt;&gt;  /opt/logs/check_ng_zbx.log</div><div>                else</div><div>                  echo &quot;$d switch BACKUP&quot; &gt;&gt;  /opt/logs/check_ng_zbx.log</div><div>                fi</div><div>                ;;</div><div>              *)</div><div>                echo &quot;USE /bin/bash /opt/scripts/$0 {master|backup}&quot;  &amp;&amp; exit 1</div><div>                ;;</div><div>            esac</div><div><br/></div><div>    d、配置keepalived主配置文件</div><div>        root&gt;vim /etc/keepalived/keepalived.conf</div><div>            <span style="font-weight: bold;">192.168.110.210上：</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;">    </span><span style="font-weight: bold;">    </span>global_defs {</div><div>                notification_email {</div><div>                    root@localhost    # 收邮件人，可以定义多个</div><div>                }</div><div>                notification_email_from kaadmin@localhost    # 发邮件人可以伪装</div><div>                smtp_server 127.0.0.1</div><div>                smtp_connect_timeout 30</div><div>                router_id LVS_DEVEL</div><div>                script_user root</div><div>            }</div><div><br/></div><div>            vrrp_script chk_nginx {</div><div>                script &quot;/bin/bash /opt/scripts/check_ng_zbx.sh nginx&quot;</div><div>                interval 3    # 脚本执行间隔</div><div>                weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）</div><div>                fall    2    # 尝试2次都成功才成功</div><div>                rise 2    # 尝试2次都失败才失败</div><div>            }</div><div><br/></div><div>            vrrp_script chk_zabbix {</div><div>                script &quot;/bin/bash /opt/scripts/check_ng_zbx.sh zabbix&quot;</div><div>                interval 3    # 脚本执行间隔</div><div>                weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）</div><div>                fall    2    # 尝试2次都成功才成功                    </div><div>                rise 2    # 尝试2次都失败才失败                    </div><div>            }</div><div><br/></div><div>            vrrp_instance VI_1 {    # 每一个vrrp_instance就是定义一个虚拟路由器</div><div>                state MASTER    # 由初始状态转换为master状态</div><div>                interface ens33    # 根据实际情况填写网卡名</div><div>                virtual_router_id 50    # 虚拟路由的id号，一般不大于255</div><div>                priority 100    # 初始化优先级</div><div>                advert_int 1    # 初始化通告</div><div>                authentication {</div><div>                    auth_type PASS        # 认证机制</div><div>                    auth_pass web123321    # 密码</div><div>                }</div><div>                virtual_ipaddress {</div><div>                    192.168.110.220</div><div>                }</div><div>                track_script {</div><div>                    chk_nginx</div><div>                    chk_zabbix</div><div>                }</div><div>            notify_master &quot;/bin/bash /opt/scripts/switch_keep.sh master&quot; #指定当切换到master时，执行的脚本</div><div>            notify_backup &quot;/bin/bash /opt/scripts/switch_keep.sh backup&quot; #指定当切换到backup时，执行的脚本</div><div>            }</div><div><br/></div><div><br/></div><div>            <span style="font-weight: bold;">192.168.110.211上：</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;">    </span><span style="font-weight: bold;">    </span>global_defs {</div><div>                notification_email {</div><div>                    root@localhost    # 收邮件人，可以定义多个</div><div>                }</div><div>                notification_email_from kaadmin@localhost    # 发邮件人可以伪装</div><div>                smtp_server 127.0.0.1</div><div>                smtp_connect_timeout 30</div><div>                router_id LVS_DEVEL</div><div>                script_user root</div><div>            }</div><div><br/></div><div>            vrrp_script chk_nginx {</div><div>                script &quot;/bin/bash /opt/scripts/check_ng_zbx.sh nginx&quot;</div><div>                interval 3    # 脚本执行间隔</div><div>                weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）</div><div>                fall    2    # 尝试2次都成功才成功</div><div>                rise 2    # 尝试2次都失败才失败</div><div>            }</div><div><br/></div><div>            vrrp_script chk_zabbix {</div><div>                script &quot;/bin/bash /opt/scripts/check_ng_zbx.sh zabbix&quot;</div><div>                interval 3    # 脚本执行间隔</div><div>                weight -30     #优先级（如果脚本执行结果为0，并且weight配置的值大于0，则优先级相应的增加，如果脚本执行结果非0，并且weight配置的值小于0，则优先级相应的减少）</div><div>                fall    2    # 尝试2次都成功才成功                    </div><div>                rise 2    # 尝试2次都失败才失败                    </div><div>            }</div><div><br/></div><div>            vrrp_instance VI_1 {    # 每一个vrrp_instance就是定义一个虚拟路由器</div><div>                state BACKUP    # 由初始状态转换为backup状态</div><div>                interface ens33    # 根据实际情况填写网卡名</div><div>                virtual_router_id 50    # 虚拟路由的id号，一般不大于255</div><div>                priority 90    # 初始化优先级</div><div>                advert_int 1    # 初始化通告</div><div>                authentication {</div><div>                    auth_type PASS        # 认证机制</div><div>                    auth_pass web123321    # 密码</div><div>                }</div><div>                virtual_ipaddress {</div><div>                    192.168.110.220</div><div>                }</div><div>                track_script {</div><div>                    chk_nginx</div><div>                    chk_zabbix</div><div>                }</div><div>            notify_master &quot;/bin/bash /opt/scripts/switch_keep.sh master&quot; #指定当切换到master时，执行的脚本</div><div>            notify_backup &quot;/bin/bash /opt/scripts/switch_keep.sh backup&quot; #指定当切换到backup时，执行的脚本</div><div>            }</div><div><br/></div><div>    e、编写检测keepalived脚本，防止zabbix_server同时运行</div><div>        root&gt;vim /opt/scripts/check_keep_zbx.sh</div><div>            #!/bin/bash</div><div>            # 时间变量</div><div>            d=`date --date today +'%Y-%m-%d %H:%M:%S'`</div><div>            # 监控keepalived是否运行，如果没运行则关闭zabbix</div><div>            kep=`ps -ef | grep keepalived | grep -v grep | wc -l`</div><div>            zbx=`ps -ef | grep zabbix_server | grep -v grep | wc -l`</div><div>            for ((i=1;i&lt;=20;i++));do</div><div>              if [ $kep -eq &quot;0&quot; ];then</div><div>                if [ $zbx -ne &quot;0&quot; ];then</div><div>                  killall zabbix_server</div><div>                  echo &quot;$d keepalived stop,stop zabbix_server&quot; &gt;&gt; /opt/logs/check_ng_zbx.log</div><div>                fi</div><div>              fi</div><div>              sleep 2.5</div><div>            done</div><div>        root&gt;crontab -e</div><div>            # 监控keepalived是否运行</div><div>            */1 * * * * /bin/bash /opt/scripts/check_keep_zbx.sh &gt;&gt;/dev/null 2&gt;&amp;1</div><div><br/></div><div>    f、开机自启并启动</div><div>        root&gt;systemctl enable keepalived</div><div>        root&gt;systemctl start keepalived</div><div><br/></div><div><br/></div><div>8、配置sudo权限和别名</div><div>    root&gt;visudo        </div><div>        Cmnd_Alias SCRIPT_COMMAND = /opt/apps/nginx/sbin/nginx, /usr/bin/systemctl stop php-fpm, /usr/bin/systemctl start php-fpm, /usr/bin/systemctl restart php-fpm,/usr/bin/vim /etc/keepalived/keepalived.conf, /usr/bin/systemctl restart keepalived, /usr/bin/systemctl start keepalived, /usr/bin/systemctl stop keepalived, /usr/bin/tailf /var/log/messages, /usr/bin/tail /var/log/messages, /usr/bin/vim /var/log/messages            # 在后面追加就行</div><div>        mtadmin ALL = NOPASSWD:SCRIPT_COMMAND</div><div>    mtadmin&gt;vim /home/mtadmin/.bashrc    # 添加别名</div><div>        alias keepalived_stop=&quot;sudo /usr/bin/systemctl stop keepalived&quot;</div><div>        alias keepalived_start=&quot;sudo /usr/bin/systemctl start keepalived&quot;</div><div>        alias keepalived_restart=&quot;sudo /usr/bin/systemctl restart keepalived&quot;</div><div>    mtadmin&gt;source /home/mtadmin/.bashrc</div><div><br/></div><div>9、rsync+sersync 实时同步文件</div><div>    a、rsync安装(直接从下载站下载编译后的包)</div><div>        mtadmin&gt;mkdir -p /opt/apps/rsync/{etc,logs}</div><div>        mtadmin&gt;cd /opt/src &amp;&amp; wget --http-user=downloader   --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf  --no-check-certificate  <a href="https://hkdownload.zhushuqt.com:8443/download/%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/rsync/rsync_source.zip">https://hkdownload.zhushuqt.com:8443/download/%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/rsync/rsync_source.zip</a></div><div>        mtadmin&gt;cd /opt/src &amp;&amp; unzip -q rsync_source.zip -d /opt/apps</div><div>    b、rsync配置</div><div>        mtadmin&gt;chmod +x /opt/apps/rsync/bin/rsync</div><div>        mtadmin&gt;echo 'rsync:RsYnCpAsWoRd' &gt; /opt/apps/rsync/etc/rsyncd.secret</div><div>        mtadmin&gt;chmod 600 /opt/apps/rsync/etc/rsyncd.secret</div><div>        mtadmin&gt;echo 'RsYnCpAsWoRd' &gt; /opt/scripts/.rsyncd.passwd</div><div>        mtadmin&gt;chmod 600 /opt/scripts/.rsyncd.passwd</div><div>        mtadmin&gt;vim /opt/apps/rsync/etc/rsyncd.conf</div><div>            port = 1873</div><div>            use chroot =no</div><div>            list = no</div><div>            log file = /opt/apps/rsync/logs/rsyncd.log</div><div>            lock file = /opt/apps/rsync/logs/rsyncd.lock</div><div>            secrets file=/opt/apps/rsync/etc/rsyncd.secret</div><div>            ignore errors</div><div>            read only=no</div><div>            list=no</div><div>            max connections=200</div><div>            timeout=600</div><div>            auth users=rsync</div><div>            hosts allow=*</div><div>            [zabbix_conf]</div><div>            path=/opt/apps/zabbix/</div><div>            comment=zabbix_conf</div><div>            [nginx_html]</div><div>            path=/opt/apps/nginx/html/zabbix/</div><div>            comment=nginx_html</div><div>    c、启动rsync</div><div>        mtadmin&gt;/opt/apps/rsync/bin/rsync --daemon --config=/opt/apps/rsync/etc/rsyncd.conf --no-detach &amp;</div><div>    e、sersync安装(直接从下载站下载编译后的包)</div><div>        mtadmin&gt;mkdir /opt/logs/sersync</div><div>        mtadmin&gt;cd /opt/src &amp;&amp; wget --http-user=downloader   --http-password=bytVi_iFD__foXZl2PpkpdH3iWgm0dcf  --no-check-certificate  <a href="https://hkdownload.zhushuqt.com:8443/download/%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/rsync/sersync_source.zip">https://hkdownload.zhushuqt.com:8443/download/%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83/%E7%BA%BF%E4%B8%8A%E5%8C%85%E4%B8%8E%E9%85%8D%E7%BD%AE/rsync/sersync_source.zip</a></div><div>        mtadmin&gt;cd /opt/src &amp;&amp; unzip -q sersync_source.zip -d /opt/apps</div><div>        mtadmin&gt;chmod +x /opt/apps/sersync/sersync2</div><div>        mtadmin&gt;rm -f /opt/apps/sersync/nginx_conf.xml</div><div>        mtadmin&gt;mv /opt/apps/sersync/data.xml zabbix_conf.xml</div><div>        mtadmin&gt;mv /opt/apps/sersync/views.xml nginx_html.xml</div><div>        mtadmin&gt;vim /opt/apps/sersync/zabbix_conf.xml</div><div>            &lt;filter start=&quot;ture&quot;&gt;</div><div>            &lt;exclude expression=&quot;zabbix_agentd.conf&quot;&gt;&lt;/exclude&gt;            # 不同步zabbix_agentd.conf</div><div>            &lt;localpath watch=&quot;/opt/apps/zabbix/&quot;&gt;</div><div>                &lt;remote ip=&quot;192.168.110.211&quot; name=&quot;zabbix_conf&quot;/&gt;        # 192.168.110.211 上把ip改成192.168.110.210</div><div>            &lt;commonParams params=&quot;-artuz --exclude=zabbix_agentd.conf&quot;/&gt;        # 修改rsync命令，不同步zabbix_agentd.conf</div><div>            &lt;failLog path=&quot;/opt/logs/sersync/rsync_fail_log_zabbix_conf.logs&quot; timeToExecute=&quot;6&quot;/&gt;&lt;!--default every 6mins execute once--&gt;</div><div>        mtadmin&gt;vim /opt/apps/sersync/nginx_html.xml</div><div>            &lt;localpath watch=&quot;/opt/apps/nginx/html/zabbix/&quot;&gt;        # # 192.168.110.211 上把ip改成192.168.110.210</div><div>                &lt;remote ip=&quot;192.168.110.211&quot; name=&quot;nginx_html&quot;/&gt;</div><div>            &lt;failLog path=&quot;/opt/logs/sersync/rsync_fail_log_nginx_html.logs&quot; timeToExecute=&quot;6&quot;/&gt;&lt;!--default every 6mins execute once--&gt;</div><div>    f、设置rsync、sersync启动别名</div><div>        mtadmin&gt;vim ~/.bashrc</div><div>            alias rsync_start=&quot;/opt/apps/rsync/bin/rsync --daemon --config=/opt/apps/rsync/etc/rsyncd.conf --no-detach &amp;&quot;</div><div>            alias sersync_zabbix_conf_start=&quot;/opt/apps/sersync/sersync2 -r -d -o /opt/apps/sersync/zabbix_conf.xml&quot;</div><div>            alias sersync_nginx_html_start=&quot;/opt/apps/sersync/sersync2 -r -d -o /opt/apps/sersync/nginx_html.xml&quot;</div><div>        mtadmin&gt;source ~/.bashrc</div><div>    g、设置开机自启</div><div>        root&gt;chmod +x /etc/rc.d/rc.local</div><div>        root&gt;vim /etc/rc.local</div><div>            ###rsync+sersync开机自启</div><div>            su mtadmin -c &quot;/opt/apps/rsync/bin/rsync --daemon --config=/opt/apps/rsync/etc/rsyncd.conf --no-detach &amp;&quot;</div><div>            su mtadmin -c &quot;/opt/apps/sersync/sersync2 -r -d -o /opt/apps/sersync/zabbix_conf.xml&quot;</div><div>            su mtadmin -c &quot;/opt/apps/sersync/sersync2 -r -d -o /opt/apps/sersync/nginx_html.xml&quot;</div><div><br/></div><hr/><div><span style="font-size: 12pt; font-weight: bold;">四、常见问题        </span>    </div><div><br/></div><div>1、无法创建配置文件</div><div><img src="【模拟真实环境】Zabbix高可用架构_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>解决方法：点击1. Download the configuration file 下载文件zabbix.conf.php,将文件放入/opt/apps/nginx/html/zabbix/conf/下</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>2、中文乱码</div><div><img src="【模拟真实环境】Zabbix高可用架构_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>在C:\Windows\Fonts中复制想要的字体，后缀为ttf，若本身问大写，请改成小写的文件后缀ttf，并上传至zabbix服务器的/opt/apps/nginx/html/zabbix/fonts/目录中,</div><div>使用sed命令替换/opt/apps/nginx/html/zabbix/include/defines.inc.php文件中DejaVuSans.ttf字段（两处，也可直接进入文件搜索DejaVuSans字符进行替换，替换时仅写文件名不写后缀名）（也可以将DejaVuSans.ttf 进行重命名为DejaVuSans.ttf.bak，上传新的字体后，更名为DejaVuSans.ttf同样可以实现）</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 