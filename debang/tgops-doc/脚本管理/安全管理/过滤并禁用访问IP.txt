#!/bin/bash


######### relation dir #######################
NGINX_CMD=/usr/local/nginx/sbin/nginx
LOGS_DIR=/usr/local/nginx/logs/
ip_bak_file=/usr/local/nginx/logs/black_ip.txt 
black_ip_file=/usr/local/nginx/logs/black_ip_jilu.txt

######## 限制一分钟的访问次数 ################
lim_number=5

######## 开始时间 ############################
start_time=`date -d"$last_minutes minutes ago" +"%H:%M:%S"`
#结束时间
stop_time=`date +"%H:%M:%S"`

####### 过滤出单位之间内的日志并统计最高ip数 ##
cd $LOGS_DIR 
  get_date=`tac access.log | awk -v st="$start_time" -v et="$stop_time" '{t=substr($4,RSTART+14,21);if(t>=st && t<=et) {print $0}}' | awk ' {print $1}' |  sort -n | uniq -c |awk '{if($1 >$lim_number) print $0}'|sort -rn`

###### 将异常ip记录 #########
  echo "$get_date" >  $ip_bak_file


###### 对异常IP进行处理 ########
for black_ip in `  cat $ip_bak_file  |awk '{print $2}'`
do
   if [ ! -z $black_ip  ];then
      #  iptables -I INPUT -s  $black_ip  -j DROP
      #  iptables-save  &> /dev/null 
      firewall-cmd --permanent --add-rich-rule="rule family=ipv4 source address=$black_ip reject"
      firewall-cmd --reload 
      echo  "$black_ip 在${start_time} 至 ${stop_time} 异常访问，已被防火墙禁掉！" >> $black_ip_file
   fi
done
